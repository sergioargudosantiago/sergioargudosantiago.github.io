<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description"
        content="Dashboard de comercio exterior espa√±ol con datos de exportaci√≥n e importaci√≥n por sectores econ√≥micos.">
    <title>Dashboard Comercio Exterior - Oposiciones SOIVRE</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=Noto+Serif:ital,wght@0,400;0,700;1,400&display=swap"
        rel="stylesheet">

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <style>
        /* CSS Variables - Clean Minimal Theme */
        :root {
            --background: 220 14% 96%;
            --foreground: 220 9% 46%;
            --card: 0 0% 100%;
            --card-foreground: 220 13% 18%;
            --primary: 217 91% 45%;
            --primary-foreground: 0 0% 100%;
            --secondary: 220 14% 96%;
            --secondary-foreground: 220 13% 18%;
            --muted: 220 14% 96%;
            --muted-foreground: 220 9% 46%;
            --accent: 217 91% 45%;
            --border: 220 13% 91%;
            --radius: 0.5rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to bottom, #f5f6f7, #e8eaed);
            position: relative;
            min-height: 100vh;
            color: hsl(var(--foreground));
        }

        html {
            scroll-behavior: smooth;
        }

        .font-serif {
            font-family: 'Cambria', 'Noto Serif', serif;
        }

        /* Dot Grid Background Pattern */
        .container-illustration {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: -1;
            background-color: #f5f6f7;
            background-image: radial-gradient(circle, #d1d5db 1px, transparent 1px);
            background-size: 24px 24px;
        }

        /* ========== GLASSMORPHISM ========== */
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.1);
            border-radius: 3rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glass-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 35px 60px -15px rgba(0, 0, 0, 0.15);
        }

        /* ========== NAVIGATION ========== */
        .nav-island {
            position: fixed;
            top: 1.5rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 50;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        }

        .nav-segment {
            position: relative;
            padding: 0.625rem 1.25rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: hsl(var(--foreground) / 0.7);
            text-decoration: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            border: 1px solid transparent;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            letter-spacing: 0.02em;
            white-space: nowrap;
        }

        .nav-segment:hover {
            color: hsl(var(--primary));
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(6, 132, 212, 0.2);
            box-shadow: 0 0 20px rgba(6, 132, 212, 0.4);
        }

        .nav-segment.active {
            color: hsl(var(--primary));
            background: rgba(6, 132, 212, 0.15);
            border-color: rgba(6, 132, 212, 0.3);
            font-weight: 600;
            box-shadow: 0 0 30px rgba(6, 132, 212, 0.6);
        }

        /* Hide desktop island on mobile */
        @media (max-width: 768px) {
            .nav-island {
                display: none;
            }
        }

        /* ========== FLOW TOGGLE ========== */
        .flow-toggle {
            display: inline-flex;
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(8px);
            border-radius: 2rem;
            padding: 0.25rem;
            gap: 0.25rem;
        }

        .flow-toggle-btn {
            padding: 0.75rem 2rem;
            border-radius: 1.5rem;
            font-weight: 600;
            font-size: 0.875rem;
            letter-spacing: 0.05em;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
            background: transparent;
            color: hsl(var(--foreground) / 0.6);
        }

        .flow-toggle-btn.active {
            background: hsl(var(--primary));
            color: white;
            box-shadow: 0 4px 12px rgba(6, 132, 212, 0.3);
        }

        /* ========== SECTOR CARDS ========== */
        .sector-card {
            cursor: pointer;
            padding: 2.5rem;
            text-align: center;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .sector-card h3 {
            font-size: 1.5rem;
            font-weight: 800;
            color: hsl(var(--primary));
            letter-spacing: 0.05em;
        }

        .sector-card:hover h3 {
            transform: scale(1.05);
        }

        /* ========== BREADCRUMBS ========== */
        .breadcrumbs {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
            font-size: 0.875rem;
            color: hsl(var(--foreground) / 0.7);
            margin-bottom: 2rem;
        }

        .breadcrumb-item {
            cursor: pointer;
            transition: color 0.2s;
        }

        .breadcrumb-item:hover {
            color: hsl(var(--primary));
        }

        .breadcrumb-separator {
            color: hsl(var(--foreground) / 0.4);
        }

        /* ========== TVA BADGE ========== */
        .tva-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 1rem;
            font-weight: 700;
            font-size: 1rem;
        }

        .tva-positive {
            background: #10b981;
            color: white;
        }

        .tva-negative {
            background: #ef4444;
            color: white;
        }

        /* ========== GRID LAYOUT ========== */
        .sector-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        /* ========== UTILITY ========== */
        .hidden {
            display: none !important;
        }
    </style>
</head>

<body class="flex min-h-screen flex-col">
    <!-- Background Illustration -->
    <div class="container-illustration"></div>

    <!-- Desktop Navigation -->
    <nav class="nav-island hidden md:flex">
        <a href="index.html" class="nav-segment">INTRODUCCI√ìN</a>
        <a href="temario.html" class="nav-segment">TEMARIO</a>
        <a href="fuentes-de-datos.html" class="nav-segment active">FUENTES DE DATOS</a>
        <a href="enlaces.html" class="nav-segment">ENLACES</a>
        <a href="sobre-mi.html" class="nav-segment">SOBRE M√ç</a>
    </nav>

    <!-- Mobile Menu Button -->
    <button
        class="md:hidden fixed top-4 right-4 z-50 p-3 min-w-[44px] min-h-[44px] flex items-center justify-center bg-white/80 backdrop-blur-md rounded-full border border-white/40 shadow-lg"
        onclick="alert('Men√∫ m√≥vil - implementar si es necesario')" aria-label="Abrir men√∫">
        <svg width="24" height="24" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
            stroke="currentColor" class="text-primary">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
    </button>

    <!-- Main Content -->
    <main class="relative flex-1 pb-24 pt-24 md:pt-32">
        <section class="w-full">
            <div class="container mx-auto max-w-6xl px-4 md:px-6">
                <div class="glass-card p-8 md:p-12 min-h-[75vh]">

                    <!-- Header -->
                    <div class="flex flex-col items-center space-y-6 text-center mb-12">
                        <h2 class="text-4xl sm:text-5xl md:text-6xl font-extrabold tracking-tight text-primary">
                            COMERCIO EXTERIOR
                        </h2>
                        <p class="max-w-[900px] font-serif text-foreground/80 text-base md:text-lg leading-relaxed">
                            Dashboard interactivo de exportaci√≥n e importaci√≥n espa√±ola por sectores econ√≥micos
                            (2021-2025)
                        </p>
                    </div>

                    <!-- Breadcrumbs -->
                    <div id="breadcrumbs" class="breadcrumbs hidden"></div>

                    <!-- Home View -->
                    <div id="homeView">
                        <!-- Flow Toggle -->
                        <div class="flex justify-center mb-12">
                            <div class="flow-toggle">
                                <button class="flow-toggle-btn active" data-flow="E" onclick="switchFlow('E')">
                                    EXPORTACI√ìN
                                </button>
                                <button class="flow-toggle-btn" data-flow="I" onclick="switchFlow('I')">
                                    IMPORTACI√ìN
                                </button>
                            </div>
                        </div>

                        <!-- Macro Sector Selection -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="glass-card sector-card" onclick="selectMacroSector('Agroalimentario')">
                                <h3>AGROALIMENTARIO</h3>
                            </div>
                            <div class="glass-card sector-card" onclick="selectMacroSector('Industrial')">
                                <h3>INDUSTRIAL</h3>
                            </div>
                        </div>
                    </div>

                    <!-- Level 1 View -->
                    <div id="level1View" class="hidden">
                        <h3 id="level1Title" class="text-3xl font-bold text-primary mb-6"></h3>
                        <div id="level1Grid" class="sector-grid"></div>
                    </div>

                    <!-- Level 2 View -->
                    <div id="level2View" class="hidden">
                        <h3 id="level2Title" class="text-3xl font-bold text-primary mb-6"></h3>
                        <div id="level2Grid" class="sector-grid"></div>
                    </div>

                    <!-- Level 3 View -->
                    <div id="level3View" class="hidden">
                        <h3 id="level3Title" class="text-3xl font-bold text-primary mb-6"></h3>
                        <div id="level3Grid" class="sector-grid"></div>
                    </div>

                    <!-- Final Data View -->
                    <div id="finalView" class="hidden">
                        <h3 id="finalTitle" class="text-3xl font-bold text-primary mb-6"></h3>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                            <!-- Chart -->
                            <div class="bg-white/60 backdrop-blur-sm border border-white/40 rounded-2xl p-8">
                                <h4 class="text-xl font-bold text-primary mb-4">Evoluci√≥n Temporal</h4>
                                <canvas id="timeSeriesChart"></canvas>
                            </div>

                            <!-- Stats -->
                            <div class="space-y-6">
                                <!-- TVA Badge -->
                                <div class="bg-white/60 backdrop-blur-sm border border-white/40 rounded-2xl p-8">
                                    <h4 class="text-xl font-bold text-primary mb-4">Variaci√≥n Anual (2024-2025)</h4>
                                    <div id="tvaContainer" class="flex justify-center"></div>
                                </div>

                                <!-- Top Countries -->
                                <div class="bg-white/60 backdrop-blur-sm border border-white/40 rounded-2xl p-8">
                                    <h4 class="text-xl font-bold text-primary mb-4">Principales Destinos</h4>
                                    <div id="countriesContainer" class="space-y-3"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-primary text-primary-foreground">
        <div class="container mx-auto flex h-16 items-center justify-center gap-6 px-4 sm:px-6 lg:px-8">
            <a href="https://www.linkedin.com/in/sergio-argudo-santiago-inspector-soivre-placeholder"
                aria-label="LinkedIn" target="_blank" rel="noopener noreferrer"
                class="transition-colors hover:text-accent">
                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                    <path
                        d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z" />
                </svg>
            </a>
            <a href="mailto:sergio.argudo.santiago@example.com" aria-label="Email" target="_blank"
                rel="noopener noreferrer" class="transition-colors hover:text-accent">
                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                </svg>
            </a>
            <a href="https://github.com/sergio-argudo" aria-label="GitHub" target="_blank" rel="noopener noreferrer"
                class="transition-colors hover:text-accent">
                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
                    <path
                        d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z" />
                </svg>
            </a>
        </div>
    </footer>

    <script>
        // ========== GLOBAL STATE ==========
        let allData = [];
        let currentFlow = 'E';
        let navigationState = {
            macroSector: null,
            lv1: null,
            lv2: null,
            lv3: null
        };
        let chartInstance = null;

        // ========== COUNTRY FLAGS ==========
        const countryFlags = {
            'China': 'üá®üá≥',
            'Francia': 'üá´üá∑',
            'Portugal': 'üáµüáπ',
            'Italia': 'üáÆüáπ',
            'Alemania': 'üá©üá™',
            'Estados Unidos': 'üá∫üá∏',
            'Reino Unido': 'üá¨üáß',
            'Jap√≥n': 'üáØüáµ',
            'Arabia Saud√≠': 'üá∏üá¶',
            'Pa√≠ses Bajos': 'üá≥üá±',
            'B√©lgica': 'üáßüá™',
            'Marruecos': 'üá≤üá¶',
            'Argelia': 'üá©üáø',
            'T√∫nez': 'üáπüá≥',
            'Emiratos √Årabes Unidos': 'üá¶üá™',
            'Corea del Sur': 'üá∞üá∑',
            'Filipinas': 'üáµüá≠',
            'Rusia': 'üá∑üá∫',
            'Grecia': 'üá¨üá∑',
            'Polonia': 'üáµüá±',
            'L√≠bano': 'üá±üáß',
            'Libia': 'üá±üáæ',
            'Jordania': 'üáØüá¥',
            'Israel': 'üáÆüá±',
            'Cuba': 'üá®üá∫',
            'M√©xico': 'üá≤üáΩ',
            'Brasil': 'üáßüá∑',
            'Chile': 'üá®üá±',
            'Suiza': 'üá®üá≠',
            'Austria': 'üá¶üáπ',
            'Suecia': 'üá∏üá™',
            'Dinamarca': 'üá©üá∞',
            'Noruega': 'üá≥üá¥',
            'Finlandia': 'üá´üáÆ',
            'Ruman√≠a': 'üá∑üá¥',
            'Ucrania': 'üá∫üá¶',
            'Turqu√≠a': 'üáπüá∑',
            'Egipto': 'üá™üá¨',
            'Sud√°frica': 'üáøüá¶',
            'India': 'üáÆüá≥',
            'Om√°n': 'üá¥üá≤',
            'Luxemburgo': 'üá±üá∫',
            'Andorra': 'üá¶üá©',
            'Mali': 'üá≤üá±',
            'Senegal': 'üá∏üá≥',
            'C√¥te d\'Ivoire': 'üá®üáÆ',
            'Mauritania': 'üá≤üá∑',
            'Vietnam': 'üáªüá≥',
            'Colombia': 'üá®üá¥',
            'Rep√∫blica Dominicana': 'üá©üá¥',
            'Rep√∫blica Democr√°tica del Congo': 'üá®üá©'
        };

        // ========== CSV PARSING (RFC 4180 COMPLIANT) ==========
        function parseCSV(text) {
            console.log('üöÄ Iniciando parsing avanzado de CSV (RFC 4180)...');
            const lines = text.trim().split('\n').filter(line => line.trim());
            console.log(`üìä Total de l√≠neas encontradas: ${lines.length}`);

            if (lines.length === 0) {
                console.error('‚ùå El archivo CSV est√° vac√≠o');
                return [];
            }

            // Parse header line
            const headers = parseCSVLineAdvanced(lines[0]);
            console.log('üìã Headers encontrados:', headers);
            const data = [];

            // Parse data lines
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLineAdvanced(lines[i]);

                if (values.length === headers.length) {
                    const row = {};
                    headers.forEach((header, index) => {
                        // Trim and normalize all values
                        const cleanHeader = header.trim();
                        let cleanValue = values[index].trim();

                        // Remove surrounding quotes if present
                        if (cleanValue.startsWith('"') && cleanValue.endsWith('"')) {
                            cleanValue = cleanValue.slice(1, -1);
                        }

                        row[cleanHeader] = cleanValue;
                    });
                    data.push(row);
                } else if (values.length > 0) {
                    console.warn(`‚ö†Ô∏è L√≠nea ${i + 1} tiene ${values.length} columnas, esperadas ${headers.length}`);
                    console.log(`   Contenido: ${lines[i].substring(0, 100)}...`);
                }
            }

            console.log(`‚úÖ Datos parseados correctamente: ${data.length} registros`);

            // Show sample data in table format for debugging
            if (data.length > 0) {
                console.log('üìä Muestra de los primeros 5 registros:');
                console.table(data.slice(0, 5));
                console.log('üîç Valores √∫nicos de macro_sector:', [...new Set(data.map(r => r.macro_sector))]);
                console.log('üîç Valores √∫nicos de flujo:', [...new Set(data.map(r => r.flujo))]);
            }

            return data;
        }

        function parseCSVLineAdvanced(line) {
            const result = [];
            let cell = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];

                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        // Handle escaped quotes ("")
                        cell += '"';
                        i++; // Skip the second quote
                    } else {
                        // Toggle quote state
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    // Aded result
                    result.push(cell);
                    cell = '';
                } else {
                    cell += char;
                }
            }
            // Add last cell
            result.push(cell);
            return result;
        }

        // ========== VALUE PARSING HELPERS ==========
        function parseNumericValue(value) {
            // Handle NA, null, empty string, or undefined
            if (!value || value === 'NA' || value === 'null' || value.trim() === '') {
                return 0;
            }

            const num = parseFloat(value);
            return isNaN(num) ? 0 : num;
        }

        function parseTVAValue(value) {
            // TVA can be NA - return null for display purposes
            if (!value || value === 'NA' || value === 'null' || value.trim() === '') {
                return null;
            }

            const num = parseFloat(value);
            return isNaN(num) ? null : num;
        }

        // ========== DATA LOADING ==========
        async function loadData() {
            const container = document.querySelector('.glass-card');
            const loadingMsg = document.createElement('div');
            loadingMsg.id = 'loadingMessage';
            loadingMsg.className = 'text-center text-primary text-xl font-bold mt-8';
            loadingMsg.innerHTML = '‚è≥ Cargando datos del comercio exterior...';
            container.appendChild(loadingMsg);

            try {
                console.log('üì• Iniciando carga del CSV...');
                const response = await fetch('datos_maestros_dashboard.csv');

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const text = await response.text();
                console.log(`üìÑ CSV cargado, tama√±o: ${text.length} caracteres`);

                allData = parseCSV(text);
                console.log(`‚úÖ Datos cargados exitosamente: ${allData.length} registros`);

                // Remove loading message
                const msg = document.getElementById('loadingMessage');
                if (msg) msg.remove();

            } catch (error) {
                console.error('‚ùå Error loading CSV:', error);
                console.error('Detalles del error:', error.message);

                const msg = document.getElementById('loadingMessage');
                if (msg) {
                    msg.innerHTML = `
                        <div class="text-center">
                            <p class="text-red-600 text-xl font-bold mb-4">‚ùå Error al cargar los datos</p>
                            <p class="text-sm text-foreground mb-4">
                                ${error.message.includes('fetch') || error.message.includes('CORS') || error.message.includes('NetworkError')
                            ? 'üö® <strong>Problema de CORS detectado</strong>: No puedes abrir este archivo directamente (file://).'
                            : 'Error: ' + error.message}
                            </p>
                            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 text-left text-sm">
                                <p class="font-bold mb-2">‚úÖ Soluci√≥n:</p>
                                <ol class="list-decimal list-inside space-y-1">
                                    <li>Abre una terminal en: <code class="bg-gray-200 px-1">c:\\sergioargudosantiago.github.io</code></li>
                                    <li>Ejecuta: <code class="bg-gray-200 px-1">python -m http.server 8000</code></li>
                                    <li>Abre: <code class="bg-gray-200 px-1">http://localhost:8000/fuentes-de-datos.html</code></li>
                                </ol>
                                <p class="mt-2 text-xs text-gray-600">Presiona F12 para ver el error completo en la consola.</p>
                            </div>
                        </div>
                    `;
                    msg.className = 'text-center text-sm mt-8 max-w-2xl mx-auto';
                }
            }
        }

        // ========== FLOW SWITCHING ==========
        function switchFlow(flow) {
            console.log(`üîÑ Cambiando flujo a: ${flow}`);
            currentFlow = flow;

            // Update toggle buttons
            document.querySelectorAll('.flow-toggle-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.flow === flow);
            });

            // Reset navigation
            resetNavigation();
        }

        // ========== NAVIGATION ==========
        function resetNavigation() {
            navigationState = {
                macroSector: null,
                lv1: null,
                lv2: null,
                lv3: null
            };
            showView('homeView');
            updateBreadcrumbs();
        }

        function selectMacroSector(sector) {
            console.log(`üìä Seleccionando macro sector: ${sector}`);
            navigationState.macroSector = sector;
            showLevel1();
        }

        function showLevel1() {
            console.log(`üîç Filtrando datos para Nivel 1...`);
            console.log(`   - Flujo actual: ${currentFlow}`);
            console.log(`   - Macro sector: ${navigationState.macroSector}`);
            console.log(`   - Total registros: ${allData.length}`);

            // Case-insensitive filtering with trim
            const filtered = allData.filter(row => {
                const flujoMatch = row.flujo && row.flujo.trim().toUpperCase() === currentFlow.trim().toUpperCase();
                const sectorMatch = row.macro_sector &&
                    row.macro_sector.trim().toLowerCase() === navigationState.macroSector.trim().toLowerCase();
                return flujoMatch && sectorMatch;
            });

            console.log(`‚úÖ Registros filtrados: ${filtered.length}`);

            if (filtered.length === 0) {
                console.warn('‚ö†Ô∏è No se encontraron registros con los filtros actuales');
                console.log('Valores disponibles de macro_sector:', [...new Set(allData.map(r => r.macro_sector))]);
                console.log('Valores disponibles de flujo:', [...new Set(allData.map(r => r.flujo))]);
            }

            // Get unique Level 1 items
            const lv1Items = {};
            filtered.forEach(row => {
                const key = row.lv1;
                if (!lv1Items[key]) {
                    lv1Items[key] = {
                        code: row.lv1,
                        name: row.lit_lv1.trim(),
                        lv2: row.lit_lv2.trim(),
                        lv3: row.lit_lv3.trim()
                    };
                }
            });

            console.log(`üìã Sectores √∫nicos de Nivel 1: ${Object.keys(lv1Items).length}`);

            // Render grid
            const grid = document.getElementById('level1Grid');
            grid.innerHTML = '';
            document.getElementById('level1Title').textContent = navigationState.macroSector.toUpperCase();

            if (Object.keys(lv1Items).length === 0) {
                grid.innerHTML = '<p class="text-center text-muted-foreground text-lg p-8">No se encontraron datos para este sector. Revisa la consola (F12) para m√°s detalles.</p>';
            } else {
                Object.values(lv1Items).forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'glass-card sector-card';
                    card.innerHTML = `<h3 class="text-lg">${item.name}</h3>`;
                    card.onclick = () => selectLevel1(item.code, item.name, item.lv2, item.lv3);
                    grid.appendChild(card);
                });
            }

            showView('level1View');
            updateBreadcrumbs();
        }

        function selectLevel1(code, name, sampleLv2, sampleLv3) {
            console.log(`üéØ Nivel 1 seleccionado: ${name} (${code})`);
            navigationState.lv1 = { code, name };

            // Check equality rule (with trimmed comparison)
            const nameTrimmed = name.trim();
            const lv2Trimmed = sampleLv2.trim();
            const lv3Trimmed = sampleLv3.trim();

            console.log(`   Comparando: lv1="${nameTrimmed}" vs lv2="${lv2Trimmed}" vs lv3="${lv3Trimmed}"`);

            if (nameTrimmed === lv2Trimmed && lv2Trimmed === lv3Trimmed) {
                console.log('   ‚û°Ô∏è Colapso total detectado, yendo a vista final');
                // Full collapse: go directly to final view
                navigationState.lv2 = { code: code, name: name };
                navigationState.lv3 = { code: code, name: name };
                showFinalView();
            } else if (nameTrimmed === lv2Trimmed) {
                console.log('   ‚û°Ô∏è Colapso parcial detectado, saltando a nivel 3');
                // Partial skip: skip level 2, show level 3
                navigationState.lv2 = { code: code, name: name };
                showLevel3();
            } else {
                console.log('   ‚û°Ô∏è Navegaci√≥n est√°ndar, mostrando nivel 2');
                // Standard path: show level 2
                showLevel2();
            }
        }

        function showLevel2() {
            const filtered = allData.filter(row =>
                row.flujo === currentFlow &&
                row.macro_sector === navigationState.macroSector &&
                row.lv1 === navigationState.lv1.code
            );

            // Get unique Level 2 items
            const lv2Items = {};
            filtered.forEach(row => {
                const key = row.lv2;
                if (!lv2Items[key]) {
                    lv2Items[key] = {
                        code: row.lv2,
                        name: row.lit_lv2,
                        lv3: row.lit_lv3
                    };
                }
            });

            // Render grid
            const grid = document.getElementById('level2Grid');
            grid.innerHTML = '';
            document.getElementById('level2Title').textContent = navigationState.lv1.name;

            Object.values(lv2Items).forEach(item => {
                const card = document.createElement('div');
                card.className = 'glass-card sector-card';
                card.innerHTML = `<h3 class="text-base">${item.name}</h3>`;
                card.onclick = () => selectLevel2(item.code, item.name, item.lv3);
                grid.appendChild(card);
            });

            showView('level2View');
            updateBreadcrumbs();
        }

        function selectLevel2(code, name, sampleLv3) {
            navigationState.lv2 = { code, name };

            // Check if lv2 == lv3 (partial skip from lv1 to lv3)
            if (name === sampleLv3) {
                navigationState.lv3 = { code: code, name: name };
                showFinalView();
            } else {
                showLevel3();
            }
        }

        function showLevel3() {
            const filtered = allData.filter(row =>
                row.flujo === currentFlow &&
                row.macro_sector === navigationState.macroSector &&
                row.lv1 === navigationState.lv1.code &&
                row.lv2 === (navigationState.lv2?.code || navigationState.lv1.code)
            );

            // Get unique Level 3 items
            const lv3Items = {};
            filtered.forEach(row => {
                const key = row.lv3;
                if (!lv3Items[key]) {
                    lv3Items[key] = {
                        code: row.lv3,
                        name: row.lit_lv3
                    };
                }
            });

            // Render grid
            const grid = document.getElementById('level3Grid');
            grid.innerHTML = '';
            document.getElementById('level3Title').textContent = navigationState.lv2?.name || navigationState.lv1.name;

            Object.values(lv3Items).forEach(item => {
                const card = document.createElement('div');
                card.className = 'glass-card sector-card';
                card.innerHTML = `<h3 class="text-sm">${item.name}</h3>`;
                card.onclick = () => selectLevel3(item.code, item.name);
                grid.appendChild(card);
            });

            showView('level3View');
            updateBreadcrumbs();
        }

        function selectLevel3(code, name) {
            navigationState.lv3 = { code, name };
            showFinalView();
        }

        // ========== FINAL VIEW ==========
        function showFinalView() {
            console.log('üìä Mostrando vista final con datos agregados...');

            const filtered = allData.filter(row =>
                row.flujo === currentFlow &&
                row.macro_sector === navigationState.macroSector &&
                row.lv3 === navigationState.lv3.code
            );

            if (filtered.length === 0) {
                console.error('‚ùå No data found for final view');
                console.log('Par√°metros de b√∫squeda:', {
                    flujo: currentFlow,
                    macro_sector: navigationState.macroSector,
                    lv3: navigationState.lv3.code
                });
                return;
            }

            console.log(`‚úÖ Registros encontrados para vista final: ${filtered.length}`);

            // Prepare yearly data with NA handling
            const yearlyData = {};
            filtered.forEach(row => {
                const year = row.year;
                const value = parseNumericValue(row.total_millones);
                yearlyData[year] = value;
            });

            console.log('üìà Datos anuales procesados:', yearlyData);

            // Get latest record for metadata
            const latestRecord = filtered[filtered.length - 1];

            // Update title
            document.getElementById('finalTitle').textContent = navigationState.lv3.name;

            // Render chart
            renderChart(yearlyData);

            // Render TVA badge
            renderTVA(latestRecord.tva_lv3);

            // Render countries
            renderCountries(latestRecord.top_paises_lv3);

            showView('finalView');
            updateBreadcrumbs();
        }

        function renderChart(yearlyData) {
            const years = ['2021', '2022', '2023', '2024', '2025'];
            const values = years.map(year => yearlyData[year] || 0);

            const ctx = document.getElementById('timeSeriesChart').getContext('2d');

            // Destroy existing chart
            if (chartInstance) {
                chartInstance.destroy();
            }

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [{
                        label: 'Millones ‚Ç¨',
                        data: values,
                        borderColor: 'hsl(217, 91%, 45%)',
                        backgroundColor: 'hsla(217, 91%, 45%, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            titleColor: '#333',
                            bodyColor: '#666',
                            borderColor: 'hsl(217, 91%, 45%)',
                            borderWidth: 2,
                            padding: 12,
                            displayColors: false,
                            callbacks: {
                                title: function (context) {
                                    return context[0].label;
                                },
                                label: function (context) {
                                    return context.parsed.y.toFixed(2) + 'M ‚Ç¨';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                callback: function (value) {
                                    return value.toFixed(0) + 'M';
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        function renderTVA(tvaValue) {
            const container = document.getElementById('tvaContainer');
            const tva = parseTVAValue(tvaValue);

            if (tva === null) {
                container.innerHTML = '<p class="text-muted-foreground">No disponible</p>';
                return;
            }

            const badgeClass = tva >= 0 ? 'tva-positive' : 'tva-negative';
            const arrow = tva >= 0 ? '‚Üë' : '‚Üì';

            container.innerHTML = `
                <div class="tva-badge ${badgeClass}">
                    <span>${Math.abs(tva).toFixed(1)}%</span>
                    <span>${arrow}</span>
                </div>
            `;
        }

        function renderCountries(countriesString) {
            const container = document.getElementById('countriesContainer');

            if (!countriesString || countriesString === 'NA') {
                container.innerHTML = '<p class="text-muted-foreground">No disponible</p>';
                return;
            }

            const countries = countriesString.split(',').map(c => c.trim()).slice(0, 3);

            container.innerHTML = countries.map(country => {
                const flag = countryFlags[country] || 'üåê';
                return `
                    <div class="flex items-center gap-3 p-3 bg-white/40 rounded-xl">
                        <span class="text-3xl">${flag}</span>
                        <span class="font-semibold text-foreground">${country}</span>
                    </div>
                `;
            }).join('');
        }

        // ========== BREADCRUMBS ==========
        function updateBreadcrumbs() {
            const container = document.getElementById('breadcrumbs');
            const crumbs = [];

            crumbs.push({ label: 'Home', action: resetNavigation });

            if (navigationState.macroSector) {
                crumbs.push({
                    label: navigationState.macroSector,
                    action: () => {
                        navigationState.lv1 = null;
                        navigationState.lv2 = null;
                        navigationState.lv3 = null;
                        showLevel1();
                    }
                });
            }

            // Only add unique breadcrumb levels (skip redundant names)
            if (navigationState.lv1) {
                const lv1Name = navigationState.lv1.name;
                const lv2Name = navigationState.lv2?.name;
                const lv3Name = navigationState.lv3?.name;

                // Add lv1 if it's different from lv2
                if (lv1Name !== lv2Name) {
                    crumbs.push({
                        label: lv1Name,
                        action: () => {
                            navigationState.lv2 = null;
                            navigationState.lv3 = null;
                            showLevel2();
                        }
                    });
                }

                // Add lv2 if it exists and is different from lv1 and lv3
                if (lv2Name && lv2Name !== lv1Name && lv2Name !== lv3Name) {
                    crumbs.push({
                        label: lv2Name,
                        action: () => {
                            navigationState.lv3 = null;
                            showLevel3();
                        }
                    });
                }

                // Add lv3 if it exists and is different from lv2
                if (lv3Name && lv3Name !== lv2Name) {
                    crumbs.push({
                        label: lv3Name,
                        action: null  // Final level, no action
                    });
                }
            }

            if (crumbs.length <= 1) {
                container.classList.add('hidden');
            } else {
                container.classList.remove('hidden');
                container.innerHTML = crumbs.map((crumb, index) => {
                    const isLast = index === crumbs.length - 1;
                    const clickable = crumb.action ? `onclick="(${crumb.action.toString()})()"` : '';
                    const cursorClass = crumb.action ? 'breadcrumb-item' : '';

                    return `
                        <span class="${cursorClass}" ${clickable}>${crumb.label}</span>
                        ${!isLast ? '<span class="breadcrumb-separator">‚Ä∫</span>' : ''}
                    `;
                }).join('');
            }
        }

        // ========== VIEW MANAGEMENT ==========
        function showView(viewId) {
            const views = ['homeView', 'level1View', 'level2View', 'level3View', 'finalView'];
            views.forEach(id => {
                document.getElementById(id).classList.toggle('hidden', id !== viewId);
            });
        }

        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', async () => {
            await loadData();
            resetNavigation();
        });
    </script>
</body>

</html>